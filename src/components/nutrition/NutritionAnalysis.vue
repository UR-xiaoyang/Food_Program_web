<template>
  <div class="nutrition-dashboard">
    <div class="three-column-layout">
      <!-- å·¦ä¾§é¢æ¿ - å¥åº·è¯„åˆ†å’Œè¥å…»æ‘„å…¥æ¯”ä¾‹ -->
      <div class="left-panel glow-effect">
        <div class="panel-section">
          <h3>å¥åº·è¯„åˆ†</h3>
          <div class="gauge-container">
            <div class="score-display">
              <span class="score">87</span>
              <span class="score-label">ä¼˜ç§€</span>
            </div>
            <canvas id="healthScoreGauge"></canvas>
          </div>
        </div>
        
        <div class="panel-section">
          <h3>è¥å…»æ‘„å…¥æ¯”ä¾‹</h3>
          <div class="pie-chart-container">
            <canvas id="nutritionPieChart"></canvas>
          </div>
          <!-- {{ edit_1: åˆ é™¤ä¸‹é¢çš„æ‰‹åŠ¨å›¾ä¾‹ }} -->
          <!-- <div class="nutrition-legend">
            <div class="legend-item">
              <span class="legend-color" style="background-color: #00ff88"></span>
              <span class="legend-text">ç¢³æ°´åŒ–åˆç‰© 60%</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background-color: #00c3ff"></span>
              <span class="legend-text">è›‹ç™½è´¨ 25%</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background-color: #ff5e62"></span>
              <span class="legend-text">è„‚è‚ª 15%</span>
            </div>
          </div> -->
        </div>
      </div>
      
      <!-- ä¸­é—´é¢æ¿ - è®¡åˆ’å®Œæˆæƒ…å†µæŠ˜çº¿å›¾ -->
      <div class="center-panel glow-effect">
        <h3>è®¡åˆ’å®Œæˆè¶‹åŠ¿</h3>
        <div class="chart-container" style="height: 300px;">
          <canvas id="planCompletionChart"></canvas>
        </div>
        
        <div class="data-summary">
          <div class="summary-card">
            <div class="summary-value">24</div>
            <div class="summary-label">æ€»è®¡åˆ’æ•°</div>
          </div>
          <div class="summary-card">
            <div class="summary-value">18</div>
            <div class="summary-label">å·²å®Œæˆ</div>
          </div>
          <div class="summary-card">
            <div class="summary-value">4</div>
            <div class="summary-label">è¿›è¡Œä¸­</div>
          </div>
          <div class="summary-card">
            <div class="summary-value">2</div>
            <div class="summary-label">æœªå®Œæˆ</div>
          </div>
        </div>
      </div>
      
      <!-- å³ä¾§é¢æ¿ - è¥å…»ç´ æ‘„å…¥å’Œå¥åº·å»ºè®® -->
      <div class="right-panel glow-effect">
        <h3>è¥å…»ç´ æ‘„å…¥</h3>
        <div class="nutrient-progress">
          <div class="nutrient-item">
            <div class="nutrient-info">
              <span class="nutrient-name">è›‹ç™½è´¨</span>
              <span class="nutrient-value">85g / 90g</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 94%"></div>
            </div>
          </div>
          
          <div class="nutrient-item">
            <div class="nutrient-info">
              <span class="nutrient-name">ç¢³æ°´åŒ–åˆç‰©</span>
              <span class="nutrient-value">220g / 250g</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 88%"></div>
            </div>
          </div>
          
          <div class="nutrient-item">
            <div class="nutrient-info">
              <span class="nutrient-name">è„‚è‚ª</span>
              <span class="nutrient-value">45g / 60g</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 75%"></div>
            </div>
          </div>
          
          <div class="nutrient-item">
            <div class="nutrient-info">
              <span class="nutrient-name">çº¤ç»´ç´ </span>
              <span class="nutrient-value">18g / 25g</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 72%"></div>
            </div>
          </div>
          
          <div class="nutrient-item">
            <div class="nutrient-info">
              <span class="nutrient-name">ç»´ç”Ÿç´ C</span>
              <span class="nutrient-value">85mg / 90mg</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 94%"></div>
            </div>
          </div>
        </div>
        
        <h3>å¥åº·å»ºè®®</h3>
        <div class="health-tips">
          <div class="tip-item">
            <div class="tip-icon">ğŸ’¡</div>
            <div class="tip-content">å¢åŠ è”¬èœæ°´æœæ‘„å…¥ï¼Œæé«˜çº¤ç»´ç´ å«é‡</div>
          </div>
          <div class="tip-item">
            <div class="tip-icon">ğŸ’§</div>
            <div class="tip-content">æ¯æ—¥é¥®æ°´é‡ä¸è¶³ï¼Œå»ºè®®å¢åŠ è‡³2000ml</div>
          </div>
          <div class="tip-item">
            <div class="tip-icon">ğŸƒ</div>
            <div class="tip-content">æœ¬å‘¨è¿åŠ¨é‡è¾¾æ ‡ï¼Œç»§ç»­ä¿æŒ</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted, onBeforeUnmount, ref } from 'vue';
import Chart from 'chart.js/auto';
// è‡ªå®šä¹‰é˜²æŠ–å‡½æ•°å®ç°
function debounce(func: Function, wait: number) {
  let timeout: NodeJS.Timeout | null = null;
  return function (...args: any[]) {
    if (timeout) clearTimeout(timeout);
    timeout = setTimeout(() => {
      func.apply(this, args);
    }, wait);
  };
}

// å­˜å‚¨å›¾è¡¨å®ä¾‹çš„å¼•ç”¨
const charts = ref<Chart[]>([]);
// ç»Ÿä¸€çš„ resize å¤„ç†å‡½æ•°
let debouncedResizeHandler: (() => void) | null = null;

const createCharts = () => {
  // é”€æ¯ç°æœ‰å›¾è¡¨å®ä¾‹ä»¥é¿å…å†…å­˜æ³„æ¼ï¼Œå¦‚æœéœ€è¦é‡æ–°åˆ›å»ºçš„è¯
  // charts.value.forEach(chart => chart.destroy());
  // charts.value = [];
  // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾å›¾è¡¨ä»…åœ¨ onMounted æ—¶åˆ›å»ºä¸€æ¬¡ï¼Œresize æ—¶åªè°ƒæ•´å¤§å°ï¼Œä¸é‡æ–°åˆ›å»º

  // å¥åº·è¯„åˆ†ä»ªè¡¨ç›˜
  const healthScoreCtx = document.getElementById('healthScoreGauge') as HTMLCanvasElement;
  if (healthScoreCtx && !charts.value.some(c => c.canvas === healthScoreCtx)) { // é¿å…é‡å¤åˆ›å»º
    const healthChart = new Chart(healthScoreCtx, {
      type: 'doughnut',
      data: {
        datasets: [{
          // {{ edit_1: è°ƒæ•´ä»ªè¡¨ç›˜é¢œè‰²ä»¥é€‚åº”ç±³è‰²èƒŒæ™¯ }}
          data: [87, 13],
          backgroundColor: ['#4CAF50', '#e0e0e0'], // æ”¹ä¸ºæ·±ç»¿ å’Œ æµ…ç°
          borderWidth: 0,
          circumference: 180,
          rotation: 270
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '80%',
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            enabled: false
          }
        }
      }
    });
    charts.value.push(healthChart);
  }

  // è¥å…»æ‘„å…¥æ¯”ä¾‹é¥¼å›¾
  const nutritionPieCtx = document.getElementById('nutritionPieChart') as HTMLCanvasElement;
  if (nutritionPieCtx && !charts.value.some(c => c.canvas === nutritionPieCtx)) {
    const nutritionChart = new Chart(nutritionPieCtx, {
      type: 'pie',
      data: {
        labels: ['ç¢³æ°´åŒ–åˆç‰©', 'è›‹ç™½è´¨', 'è„‚è‚ª'],
        datasets: [{
          data: [60, 25, 15],
          // {{ edit_1: è°ƒæ•´é¥¼å›¾é¢œè‰²ä¸ºæ›´æ·±çš„è‰²è°ƒ }}
          // ä¾‹å¦‚ï¼Œä½¿ç”¨æ›´é¥±å’Œæˆ–ç¨æš—çš„é¢œè‰²
          backgroundColor: ['#4CAF50', '#1E88E5', '#E53935'], // æ·±ç»¿ã€æ·±è“ã€æ·±çº¢
          borderWidth: 1, // å¯ä»¥æ·»åŠ ä¸€ä¸ªç»†è¾¹æ¡†å¢åŠ åŒºåˆ†åº¦
          borderColor: '#fff' // ç™½è‰²è¾¹æ¡†
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'right',
            labels: {
              color: 'rgba(0, 0, 0, 1)', // ä¿æŒé»‘è‰²å›¾ä¾‹æ–‡å­—
              boxWidth: 12,
              padding: 20
            }
          }
          // å¯ä»¥è€ƒè™‘æ·»åŠ  tooltip æ ·å¼è°ƒæ•´ï¼Œå¦‚æœéœ€è¦çš„è¯
        }
      }
    });
    charts.value.push(nutritionChart);
  }

  // è®¡åˆ’å®Œæˆæƒ…å†µæŠ˜çº¿å›¾
  const planCompletionCtx = document.getElementById('planCompletionChart') as HTMLCanvasElement;
  if (planCompletionCtx && !charts.value.some(c => c.canvas === planCompletionCtx)) {
    const planChart = new Chart(planCompletionCtx, {
      type: 'line',
      data: {
        labels: ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'],
        datasets: [{
          label: 'å®Œæˆç‡',
          data: [85, 90, 75, 95, 80, 88, 92],
          // {{ edit_2: è°ƒæ•´æŠ˜çº¿å›¾é¢œè‰²ä¸ºæ›´æ·±çš„ç»¿è‰²è°ƒ }}
          borderColor: '#388E3C', // æ›´æ·±çš„ç»¿è‰²çº¿æ¡
          backgroundColor: 'rgba(56, 142, 60, 0.3)', // å¯¹åº”æ·±ç»¿è‰²çš„åŠé€æ˜å¡«å……
          tension: 0.4,
          fill: true,
          pointBackgroundColor: '#388E3C', // æ•°æ®ç‚¹é¢œè‰²
          pointBorderColor: '#fff', // æ•°æ®ç‚¹è¾¹æ¡†
          pointHoverBackgroundColor: '#fff', // æ‚¬åœæ—¶æ•°æ®ç‚¹èƒŒæ™¯
          pointHoverBorderColor: '#388E3C' // æ‚¬åœæ—¶æ•°æ®ç‚¹è¾¹æ¡†
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
          // å¯ä»¥è€ƒè™‘æ·»åŠ  tooltip æ ·å¼è°ƒæ•´
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: (value) => `${value}%`,
              color: 'rgba(0, 0, 0, 1)' // ä¿æŒé»‘è‰² Y è½´åˆ»åº¦
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.1)' // ä¿æŒæµ…ç°è‰²ç½‘æ ¼çº¿
            }
          },
          x: {
            ticks: {
              color: 'rgba(0, 0, 0, 1)' // ä¿æŒé»‘è‰² X è½´åˆ»åº¦
            },
            grid: {
              color: 'rgba(0, 0, 0, 0.1)' // ä¿æŒæµ…ç°è‰²ç½‘æ ¼çº¿
            }
          }
        }
      }
    });
    charts.value.push(planChart);
  }
};

// å®šä¹‰ç»Ÿä¸€çš„ resize å¤„ç†é€»è¾‘
const handleResize = () => {
  charts.value.forEach(chart => {
    chart.resize();
  });
};

onMounted(() => {
  createCharts();
  debouncedResizeHandler = debounce(handleResize, 300);
  window.addEventListener('resize', debouncedResizeHandler);
});

onBeforeUnmount(() => {
  charts.value.forEach(chart => chart.destroy());
  charts.value = [];
  if (debouncedResizeHandler) {
      window.removeEventListener('resize', debouncedResizeHandler);
  }
});

</script>

<style lang="scss" scoped>
// {{ edit_6: å¯¼å…¥åŸºç¡€æ ·å¼ï¼Œå¦‚æœ nutrition.scss åŒ…å«èƒŒæ™¯ç›¸å…³çš„è®¾ç½®ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ }}
@use '../../css/nutrition' as *;

// {{ edit_7: è®¾ç½®æ•´ä½“èƒŒæ™¯å’ŒåŸºç¡€æ–‡å­—é¢œè‰² }}
.nutrition-dashboard {
  // {{ edit_1: ä½¿ç”¨ !important å¼ºåˆ¶åº”ç”¨èƒŒæ™¯è‰² }}
  background-color: #d2b48c !important; // Tan / æ£•è¤è‰²èƒŒæ™¯
  padding: 2rem; 
  color: #333; // é»˜è®¤æ–‡å­—é¢œè‰²ä¿æŒæ·±ç°
}

// {{ edit_8: è°ƒæ•´ä¸‰åˆ—å¸ƒå±€å’Œé¢æ¿æ ·å¼ }}
.three-column-layout {
  // ... ä¿æŒåŸæœ‰å¸ƒå±€æ ·å¼ï¼Œå¦‚ display: grid ...
}

.left-panel,
.center-panel,
.right-panel {
  // {{ edit_2: è€ƒè™‘å°†é¢æ¿èƒŒæ™¯æ”¹ä¸ºæŸ”å’Œçš„ç°ç™½è‰²ï¼Œä»¥å‡å°‘ä¸æ·±èƒŒæ™¯çš„å¯¹æ¯”åº¦ }}
  background-color: #fdfbf6; // éå¸¸æµ…çš„ç°ç™½è‰²ï¼Œæ¯”çº¯ç™½æŸ”å’Œ
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15); // å¯ä»¥ç¨å¾®åŠ æ·±é˜´å½±
  // animation: none; // ç§»é™¤ glow-effect åŠ¨ç”»
}

.dashboard-title {
  font-size: 2.5rem;
  // {{ edit_9: è°ƒæ•´æ ‡é¢˜é¢œè‰²å’Œé˜´å½± }}
  color: #388E3C; // æ·±ç»¿è‰²
  text-align: center;
  margin-bottom: 2rem;
  // text-shadow: 0 0 15px rgba(0, 255, 136, 0.5); // ç§»é™¤æˆ–æ›´æ”¹æ–‡å­—é˜´å½±
  text-shadow: none;
  font-weight: 300;
  letter-spacing: 2px;
}

.panel-section h3 {
  color: #333; // ç¡®ä¿å°æ ‡é¢˜æ˜¯æ·±è‰²
  margin-bottom: 1rem;
  border-bottom: 1px solid #eee; // æ·»åŠ åˆ†éš”çº¿
  padding-bottom: 0.5rem;
}

// {{ edit_1: æ·»åŠ  position: relative ä½¿ç»å¯¹å®šä½çš„å­å…ƒç´ ç›¸å¯¹æ­¤å®¹å™¨å®šä½ }}
.gauge-container {
  position: relative; // ç¡®ä¿ .score-display ç›¸å¯¹äºæ­¤å®¹å™¨å®šä½
  // å¯ä»¥æ ¹æ®éœ€è¦è®¾ç½®ä¸€ä¸ªæœ€å°é«˜åº¦æˆ–å®½é«˜æ¯”ï¼Œä»¥ä¿è¯å®¹å™¨æœ‰å°ºå¯¸
  min-height: 150px; // ç¤ºä¾‹ï¼šè®¾ç½®æœ€å°é«˜åº¦ï¼Œé¿å…å®¹å™¨åå¡Œ
  display: flex; // ä½¿ç”¨ flex å¸ƒå±€å¸®åŠ©ç®¡ç† canvas å°ºå¯¸
  justify-content: center; // æ°´å¹³å±…ä¸­ canvas (å¦‚æœéœ€è¦)
  align-items: center; // å‚ç›´å±…ä¸­ canvas (å¦‚æœéœ€è¦)
}

.score-display {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  z-index: 10; // ç¡®ä¿æ–‡å­—åœ¨å›¾è¡¨ä¸Šæ–¹
}

.score {
  display: block;
  font-size: 3rem;
  font-weight: 700;
  color: #388E3C; // æ·±ç»¿è‰²
  line-height: 1;
}

.score-label {
  font-size: 1rem;
  color: #555; // æ·±ç°è‰²
}

/* ç§»é™¤æ‰‹åŠ¨å›¾ä¾‹æ ·å¼ï¼Œå› ä¸ºå·²åˆ é™¤ HTML */
/* .nutrition-legend { ... } */
/* .legend-item { ... } */
/* .legend-color { ... } */
/* .legend-text { ... } */

.data-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); // å“åº”å¼åˆ—
  gap: 1rem;
  margin-top: 1.5rem; // è°ƒæ•´é—´è·
}

.summary-card {
  // {{ edit_11: è°ƒæ•´æ±‡æ€»å¡ç‰‡æ ·å¼ (ç»§ç»­) }}
  // {{ edit_3: ä½¿ç”¨ä¸é¢æ¿ä¸€è‡´çš„éå¸¸æµ…çš„ç°è‰²èƒŒæ™¯ }}
  background: #f9f9f9; // ä¿æŒæˆ–æ”¹ä¸º #fdfbf6 çš„è¿‘ä¼¼è‰²
  border-radius: 8px;
  padding: 1rem;
  text-align: center;
  border: 1px solid #ddd; // è¾¹æ¡†é¢œè‰²åŠ æ·±ä¸€ç‚¹
}

.summary-value {
  font-size: 2rem;
  font-weight: 700;
  // {{ edit_12: è°ƒæ•´æ±‡æ€»æ•°å€¼é¢œè‰² }}
  color: #388E3C; // æ·±ç»¿è‰²
  margin-bottom: 0.5rem;
}

.summary-label {
  font-size: 0.8rem;
  // {{ edit_13: è°ƒæ•´æ±‡æ€»æ ‡ç­¾é¢œè‰² }}
  color: #666; // ç¨æ·±çš„ç°è‰²
}

.nutrient-progress {
  margin-bottom: 2rem;
}

.nutrient-item {
  margin-bottom: 1rem;
}

.nutrient-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.3rem;
}

.nutrient-name {
  // {{ edit_14: è°ƒæ•´è¥å…»ç´ åç§°é¢œè‰² }}
  color: #555; // æ·±ç°è‰²
}

.nutrient-value {
  // {{ edit_15: è°ƒæ•´è¥å…»ç´ æ•°å€¼é¢œè‰² }}
  color: #388E3C; // æ·±ç»¿è‰²
}

.progress-bar {
  height: 8px;
  // {{ edit_16: è°ƒæ•´è¿›åº¦æ¡èƒŒæ™¯è‰² }}
  background: #e0e0e0; // æµ…ç°è‰²èƒŒæ™¯
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  // {{ edit_17: è°ƒæ•´è¿›åº¦æ¡å¡«å……è‰² }}
  background: linear-gradient(90deg, #66BB6A, #43A047); // ç»¿è‰²æ¸å˜
  border-radius: 4px;
}

.health-tips {
  // {{ edit_18: è°ƒæ•´å¥åº·å»ºè®®åŒºåŸŸæ ·å¼ }}
  // {{ edit_4: ä½¿ç”¨ä¸é¢æ¿ä¸€è‡´çš„èƒŒæ™¯è‰² }}
  background: #fdfbf6; // ä¸é¢æ¿èƒŒæ™¯åè°ƒ
  border-radius: 8px;
  padding: 1rem;
  border: 1px solid #ddd; // è¾¹æ¡†é¢œè‰²åŠ æ·±ä¸€ç‚¹
}

.tip-item {
  display: flex;
  align-items: start; // å›¾æ ‡å’Œæ–‡å­—é¡¶éƒ¨å¯¹é½å¯èƒ½æ›´å¥½
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  // {{ edit_19: è°ƒæ•´åˆ†éš”çº¿é¢œè‰² }}
  border-bottom: 1px solid #eee; // æ›´æµ…çš„ç°è‰²åˆ†éš”çº¿

  &:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }
}

.tip-icon {
  font-size: 1.5rem;
  margin-right: 1rem;
  color: #FBC02D; // ä¾‹å¦‚ï¼Œä½¿ç”¨é»„è‰²å›¾æ ‡
  line-height: 1.5; // ç¡®ä¿ä¸æ–‡æœ¬è¡Œé«˜ä¸€è‡´
}

.tip-content {
  // {{ edit_20: è°ƒæ•´å»ºè®®å†…å®¹é¢œè‰² }}
  color: #555; // æ·±ç°è‰²
  font-size: 0.9rem;
  line-height: 1.5;
}

// {{ edit_21: ç§»é™¤æˆ–æ³¨é‡Šæ‰è¾‰å…‰åŠ¨ç”»ï¼Œå› ä¸ºå®ƒåœ¨æµ…è‰²èƒŒæ™¯ä¸‹å¯èƒ½ä¸åˆé€‚ }}
/* @keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); // ä½¿ç”¨ç»¿è‰²è°ƒçš„è¾‰å…‰
  }
  70% {
    box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
  }
} */

/* .glow-effect {
  animation: pulse 2s infinite;
} */

// {{ edit_22: (å¯é€‰) ç§»é™¤é¢æ¿ä¸Šçš„ glow-effect ç±»åº”ç”¨ï¼Œå¦‚æœä½ æ³¨é‡Šæ‰äº†åŠ¨ç”» }}
// åœ¨ <template> éƒ¨åˆ†çš„ .left-panel, .center-panel, .right-panel ä¸Šç§»é™¤ glow-effect ç±»
/*
      <div class="left-panel"> // ç§»é™¤ glow-effect
        ...
      </div>
      <div class="center-panel"> // ç§»é™¤ glow-effect
        ...
      </div>
      <div class="right-panel"> // ç§»é™¤ glow-effect
        ...
      </div>
*/


</style>